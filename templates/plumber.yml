spec:
  inputs:
    # Authentication
    # Requires a GitLab token with read_api + read_repository scopes
    # Set GITLAB_TOKEN as a CI/CD variable in Settings > CI/CD > Variables
    gitlab_token:
      description: "GitLab API token (requires read_api + read_repository scopes)"
      default: $GITLAB_TOKEN
    
    # Project configuration
    # These can be overridden but default to GitLab CI predefined variables
    project_path:
      description: "Full path of the GitLab project to analyze"
      default: $CI_PROJECT_PATH
    branch:
      description: "Branch to analyze"
      default: $CI_COMMIT_REF_NAME
    server_url:
      description: "GitLab instance URL"
      default: $CI_SERVER_URL
    
    # Control configuration
    # Default conf can be found at https://gitlab.com/getplumber/plumber/-/blob/main/.plumber.yaml
    # Priority: 1) config_file input (if set), 2) .plumber.yaml in repo (if exists), 3) default config
    config_file:
      description: "Path to your .plumber.yaml config file (relative to repo root). If not set, uses .plumber.yaml from repo if present, otherwise uses default config."
      default: ""
    
    # Compliance configuration
    threshold:
      description: "Minimum compliance percentage required to pass (0-100)"
      type: number
      default: 100
    
    # Output configuration
    print_output:
      description: "Print text output to stdout"
      type: boolean
      default: true
    output_file:
      description: "Write JSON results to file (optional, leave empty to skip)"
      default: "plumber-report.json"
    
    # Job configuration
    stage:
      description: "Stage to run the job in"
      default: ".pre"
    image:
      description: "Docker image to use for the job"
      default: "getplumber/plumber:0.1"
    allow_failure:
      description: "Allow the job to fail without failing the pipeline"
      default: false
      type: boolean
    verbose:
      description: "Enable verbose/debug output for troubleshooting"
      default: false
      type: boolean

---

# Plumber Component
# Analyzes GitLab CI/CD pipelines for compliance issues
#
# Prerequisites:
#   1. Create a GitLab token (PAT or Project/Group Access Token) with:
#      - read_api scope
#      - read_repository scope
#   2. Add it as GITLAB_TOKEN in Settings > CI/CD > Variables
#      (use masked & protected for security)
#
# Configuration file priority:
#   1. If config_file input is set → uses $CI_PROJECT_DIR/<config_file>
#   2. If .plumber.yaml exists in repo root → uses $CI_PROJECT_DIR/.plumber.yaml
#   3. Otherwise → uses default config embedded in the container
#
# Usage in .gitlab-ci.yml:
#   include:
#     - component: gitlab.com/getplumber/plumber/plumber@~latest
#
# With custom config file:
#   include:
#     - component: gitlab.com/getplumber/plumber/plumber@v0.1.0
#       inputs:
#         config_file: "configs/my-plumber.yaml"  # relative to repo root
#
# With other custom inputs:
#   include:
#     - component: gitlab.com/getplumber/plumber/plumber@v0.1.0
#       inputs:
#         threshold: 80
#         output_file: results.json
#         gitlab_token: $MY_CUSTOM_TOKEN_VAR

"plumber":
  stage: $[[ inputs.stage ]]
  image:
    name: $[[ inputs.image ]]
    entrypoint: [""]  # Override ENTRYPOINT to allow shell script execution
  variables:
    # Use intermediate variable to avoid self-reference when default is $GITLAB_TOKEN
    PLUMBER_TOKEN: $[[ inputs.gitlab_token ]]
  script:
    - |
      # Export as GITLAB_TOKEN for the CLI
      export GITLAB_TOKEN="$PLUMBER_TOKEN"
      
      # Determine config file path
      # Priority: 1) config_file input (if set), 2) .plumber.yaml in repo (if exists), 3) default config
      CONFIG_PATH=""
      if [ -n "$[[ inputs.config_file ]]" ]; then
        # User provided a custom config path (relative to repo root)
        CONFIG_PATH="$CI_PROJECT_DIR/$[[ inputs.config_file ]]"
        echo "Using custom config: $CONFIG_PATH"
      elif [ -f "$CI_PROJECT_DIR/.plumber.yaml" ]; then
        # User has .plumber.yaml in their repo
        CONFIG_PATH="$CI_PROJECT_DIR/.plumber.yaml"
        echo "Using repo config: $CONFIG_PATH"
      else
        # Use default config embedded in the container
        CONFIG_PATH="/.plumber.yaml"
        echo "Using default config: $CONFIG_PATH"
      fi
      
      OUTPUT_FLAG=""
      if [ -n "$[[ inputs.output_file ]]" ]; then
        OUTPUT_FLAG="--output $[[ inputs.output_file ]]"
      fi
      VERBOSE_FLAG=""
      if [ "$[[ inputs.verbose ]]" = "true" ]; then
        VERBOSE_FLAG="--verbose"
      fi
      /plumber analyze \
        --gitlab-url "$[[ inputs.server_url ]]" \
        --project "$[[ inputs.project_path ]]" \
        --branch "$[[ inputs.branch ]]" \
        --config "$CONFIG_PATH" \
        --threshold "$[[ inputs.threshold ]]" \
        --print="$[[ inputs.print_output ]]" \
        $OUTPUT_FLAG \
        $VERBOSE_FLAG
  artifacts:
    paths:
      - $[[ inputs.output_file ]]
    when: always
    expire_in: 1 week
  allow_failure: $[[ inputs.allow_failure ]]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
